app-id: com.realm667.Wolfenstein_Blade_of_Agony
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '20.08'
command: gzdoom
finish-args:
  - --device=all # includes dri
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --socket=pulseaudio
  - --env=DOOMWADDIR=/app/share/games/doom
  - --persist=.config/gzdoom
cleanup:
  - /include
  - /lib/cmake
  - /share/doc
modules:
  - name: p7zip # required to assemble wolf_boa.ipk3
    no-autogen: true
    make-args:
      - 7z
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/jinfeihan57/p7zip/archive/v17.04.tar.gz
        sha256: ea029a2e21d2d6ad0a156f6679bd66836204aa78148a4c5e498fe682e77127ef
        x-checker-data:
          type: anitya
          project-id: 2583
          url-template: https://github.com/jinfeihan57/p7zip/archive/refs/tags/v$version.tar.gz
      - type: shell
        commands:
          - sed -i 's|/usr/local|/app|g' makefile.common

  - name: wolfenstein
    buildsystem: simple
    sources:
      - type: archive
        url: https://github.com/Realm667/WolfenDoom/archive/refs/tags/v3.0.tar.gz
        sha256: e0b3955ca18336f45b0ad34e62dac538dc2e371cb2c7e5087480aa5db1005f30
        x-checker-data:
          type: anitya
          project-id: 155422
          url-template: https://github.com/Realm667/WolfenDoom/archive/refs/tags/$version.tar.gz
  # generated with 'convert boa.ico[0] -background none -flatten -resize 128 boa.png' from
  # https://github.com/Realm667/WolfenDoom/blob/master/boa.ico
      - type: file
        path: boa-64.png
      - type: file
        path: boa-128.png
      - type: file
        path: boa-256.png
    build-commands:
      - sed -i 's|$zipname|wolf_boa.ipk3|g' ./build.sh
      - sed -i 's|then mv|then true|g' ./build.sh
      - ./build.sh --release
      - install -Dm 644 wolf_boa.ipk3 -t /app/share/games/doom/
      - sed -i 's|/usr|/app|g' dist/com.realm667.Wolfenstein_Blade_of_Agony.desktop
      - install -Dm 644 dist/com.realm667.Wolfenstein_Blade_of_Agony.desktop -t /app/share/applications/
      - install -Dm 644 dist/com.realm667.Wolfenstein_Blade_of_Agony.metainfo.xml
        -t /app/share/metainfo/
      - |
        for size in 64 128 256; do
          install -Dm 644 boa-${size}.png /app/share/icons/hicolor/${size}x${size}/apps/com.realm667.Wolfenstein_Blade_of_Agony.png
        done

  - name: zmusic # build dependency of gzdoom
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/coelckers/ZMusic/archive/1.1.6.tar.gz
        sha256: 2cc4a08c4d213df80743828538631f452e1858c2ea5bb47a616e221492de05c0
        x-checker-data:
          type: anitya
          project-id: 153600
          url-template: https://github.com/coelckers/ZMusic/archive/refs/tags/$version.tar.gz

  - name: gzdoom
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/coelckers/gzdoom/archive/55ce0510c2b181b941d30778f29b83a06955bb56.zip
        sha256: d4c8e8594e10e423f881ff3115e3b6a6b0da6b6de73cef06b4c2801a994381d5
        x-checker-data:
          type: anitya
          stable-only: true
          project-id: 17531
          url-template: https://github.com/coelckers/gzdoom/archive/refs/tags/g$version.tar.gz
    # when updating gzdoom, update WidePix to commit used in the submodule:
    # https://github.com/coelckers/gzdoom/tree/master/wadsrc_widescreen
      - type: archive 
        url: https://github.com/nashmuhandes/WidePix/archive/f4bb3541edd570cbccb58e5cdaba3dc0979208b9.zip
        sha256: 6d0d61d30f7285b6049be6fcc9959f63e0b331a6a40b4ec5728049f2687a5f0d
        dest: wadsrc_widescreen/static
